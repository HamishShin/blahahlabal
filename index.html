<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Graph Lights Puzzle</title>

<style>
body {
  background:#111;
  color:white;
  font-family:sans-serif;
  text-align:center;
}

svg {
  background:#1a1a1a;
  border-radius:10px;
  margin-top:10px;
}

circle {
  cursor:pointer;
  transition:fill 0.15s;
}

line, path {
  stroke:#777;
  stroke-width:2;
}

text {
  pointer-events:none;
  font-size:14px;
  font-weight:bold;
  fill:black;
  text-anchor:middle;
  dominant-baseline:middle;
}

button, select, input {
  margin:4px;
}

#matrixPanel {
  display:none;
  margin:12px auto;
  width:220px;
  background:#222;
  padding:10px;
  border-radius:8px;
  font-family:monospace;
}
</style>
</head>

<body>

<h2>Graph Lights Puzzle</h2>

<select id="modeSelect">
  <option value="grid">Grid</option>
  <option value="ring">Ring</option>
  <option value="custom">Custom</option>
</select>

<button id="modeBtn">Mode: PLAY</button>
<button id="displayBtn">Display: Colors</button>

States (k):
<input type="number" id="kInput" value="3" min="2" max="9">

<br>

<button id="randomBtn">Randomize</button>
<button id="linearBtn">Linearize</button>

<div id="controls"></div>

<svg id="svg" width="400" height="400"></svg>

<div id="matrixPanel">
  <h4>Matrix (N Ã— 1)</h4>
  <pre id="rawMatrix"></pre>
  <h4>Matrix mod k</h4>
  <pre id="modMatrix"></pre>
</div>

<script>
/* ---------- GLOBALS ---------- */

const svg = document.getElementById("svg");
const SIZE = 400;
const R = 12;

let nodes = [];
let edges = [];
let adjacency = () => [];

let editMode = false;
let showNumbers = false;
let kStates = 3;

let linearOrder = [];
let pressVectors = [];
let pressMatrix = [];

/* ---------- COLORS ---------- */

function colorFor(v) {
  const hues = [0, 220, 120, 40, 300, 180];
  return `hsl(${hues[v % hues.length]},80%,50%)`;
}

/* ---------- CORE ---------- */

function clearAll() {
  svg.innerHTML = "";
  nodes = [];
  edges = [];
}

function drawEdges() {
  svg.querySelectorAll("line").forEach(l => l.remove());
  edges.forEach(e => {
    const l = document.createElementNS("http://www.w3.org/2000/svg","line");
    l.setAttribute("x1",nodes[e[0]].x);
    l.setAttribute("y1",nodes[e[0]].y);
    l.setAttribute("x2",nodes[e[1]].x);
    l.setAttribute("y2",nodes[e[1]].y);
    svg.insertBefore(l, svg.firstChild);
  });
}

function updateNode(n) {
  n.c.setAttribute("fill", colorFor(n.state));
  if (showNumbers) {
    n.t.textContent = n.state;
    n.t.setAttribute("x",n.x);
    n.t.setAttribute("y",n.y);
  } else {
    n.t.textContent = "";
  }
}

function toggleSingle(i) {
  nodes[i].state = (nodes[i].state + 1) % kStates;
  updateNode(nodes[i]);
}

function toggleWithNeighbors(i) {
  adjacency(i).forEach(j => toggleSingle(j));
  applyPress(i);
}

/* ---------- NODE ---------- */

function addNode(x,y) {
  const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
  c.setAttribute("cx",x);
  c.setAttribute("cy",y);
  c.setAttribute("r",R);

  const t = document.createElementNS("http://www.w3.org/2000/svg","text");

  const node = {x,y,state:2,c,t};
  const index = nodes.length;

  c.onclick = () => {
    if (editMode) toggleSingle(index);
    else toggleWithNeighbors(index);
  };

  svg.appendChild(c);
  svg.appendChild(t);
  nodes.push(node);
  updateNode(node);
}

/* ---------- GRID ---------- */

function drawGrid(r,c) {
  clearAll();
  const dx = SIZE/(c+1);
  const dy = SIZE/(r+1);

  for(let y=0;y<r;y++)
    for(let x=0;x<c;x++)
      addNode(dx*(x+1),dy*(y+1));

  adjacency = i => {
    const rr=Math.floor(i/c), cc=i%c;
    const a=[i];
    if(rr>0)a.push(i-c);
    if(rr<r-1)a.push(i+c);
    if(cc>0)a.push(i-1);
    if(cc<c-1)a.push(i+1);
    return a;
  };
}

/* ---------- RING ---------- */

function drawRing(n) {
  clearAll();
  const cx=SIZE/2, cy=SIZE/2, rad=140;

  for(let i=0;i<n;i++) {
    const a=2*Math.PI*i/n;
    addNode(cx+rad*Math.cos(a),cy+rad*Math.sin(a));
  }

  adjacency = i => [
    i,(i-1+n)%n,(i+1)%n
  ];
}

/* ---------- LINEARIZATION ---------- */

function linearize() {
  linearOrder = nodes.map((_,i)=>i);

  nodes.forEach((n,i)=>{
    n.x = SIZE/2;
    n.y = 40 + i*(SIZE-80)/(nodes.length-1||1);
    n.c.setAttribute("cx",n.x);
    n.c.setAttribute("cy",n.y);
    n.t.setAttribute("x",n.x);
    n.t.setAttribute("y",n.y);
  });

  buildPressVectors();
  startMatrix();
}

/* ---------- MATRICES ---------- */

function buildPressVectors() {
  pressVectors = [];
  const N = nodes.length;

  for(let i=0;i<N;i++) {
    const v = Array(N).fill(0);
    adjacency(i).forEach(j=>{
      const idx = linearOrder.indexOf(j);
      v[idx]=1;
    });
    pressVectors.push(v);
  }
}

function startMatrix() {
  pressMatrix = nodes.map(n=>n.state);
  document.getElementById("matrixPanel").style.display="block";
  updateMatrix();
}

function applyPress(i) {
  if (!pressVectors.length) return;
  const v = pressVectors[linearOrder.indexOf(i)];
  for(let j=0;j<v.length;j++) pressMatrix[j]+=v[j];
  updateMatrix();
}

function updateMatrix() {
  const raw = pressMatrix.map(v=>`[ ${v} ]`).join("\n");
  const mod = pressMatrix.map(v=>`[ ${((v%kStates)+kStates)%kStates} ]`).join("\n");
  rawMatrix.textContent = raw;
  modMatrix.textContent = mod;
}

/* ---------- UI ---------- */

modeBtn.onclick = () => {
  editMode=!editMode;
  modeBtn.textContent = `Mode: ${editMode?"EDIT":"PLAY"}`;
};

displayBtn.onclick = () => {
  showNumbers=!showNumbers;
  displayBtn.textContent = `Display: ${showNumbers?"Numbers":"Colors"}`;
  nodes.forEach(updateNode);
};

kInput.onchange = e => kStates = +e.target.value;

randomBtn.onclick = () => {
  nodes.forEach(n=>{
    n.state=Math.floor(Math.random()*kStates);
    updateNode(n);
  });
};

linearBtn.onclick = linearize;

modeSelect.onchange = e => {
  document.getElementById("matrixPanel").style.display="none";
  if(e.target.value==="grid") drawGrid(5,5);
  if(e.target.value==="ring") drawRing(12);
};

drawGrid(5,5);
</script>

</body>
</html>
