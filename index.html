<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lights Out Graph Builder</title>
<style>
  body {
    background: #111;
    color: white;
    font-family: sans-serif;
    text-align: center;
  }
  svg {
    background: #1a1a1a;
    border-radius: 10px;
    margin-top: 10px;
    cursor: crosshair;
  }
  circle { cursor: pointer; }
  text {
    pointer-events: none;
    font-size: 14px;
    font-weight: bold;
    fill: white;
    text-anchor: middle;
    dominant-baseline: middle;
  }
  button, select, input { margin: 5px; }
</style>
</head>
<body>

<h2>Lights Out Graph Builder</h2>

<select id="graphMode">
  <option value="grid">Grid</option>
  <option value="ring">Ring</option>
  <option value="custom">Custom</option>
</select>

<!-- Global Mode toggle button (all modes) -->
<button id="modeBtn">Mode: PLAY</button>

<!-- Custom mode buttons -->
<div id="customControls" style="margin:5px;">
  <button id="editToggleBtn">Start Editing</button>
  <button id="addNodeBtn">Add Node</button>
  <button id="addEdgeBtn">Add Edge</button>
</div>

<!-- Preset graph controls (grid/ring) -->
<div id="presetControls" style="margin:5px;"></div>

<!-- Shared controls -->
<div style="margin:5px;">
  <button id="randomBtn">Randomize</button>
  <button id="displayBtn">Display: COLORS</button>
  <button id="linearBtn">Linearize</button>
  States (k):
  <input type="number" id="stateCount" value="2" min="2" max="8">
</div>

<svg id="svg" width="600" height="600"></svg>

<script>
const svg=document.getElementById("svg");
const customControls=document.getElementById("customControls");
const presetControls=document.getElementById("presetControls");

const SIZE=600;
const R=12;
const COLORS=["#ff0000","#0000ff","#00ff00","#ffff00","#ff00ff","#00ffff","#ffffff","#ff8800"];

let nodes=[], labels=[];
let positions=[], originalPositions=[];
let edges=new Set();

let editMode=false; // Starts in PLAY mode for all
let displayMode="colors";
let k=2;
let linear=false;
let graphType="grid";

let addingNode=false;
let addingEdge=false;
let edgeStart=null;

/* ---------- CORE ---------- */
function reset(){
  svg.innerHTML="";
  nodes=[]; labels=[];
  positions=[]; originalPositions=[];
  edges.clear();
}

function adjacency(i){
  const a=[i];
  edges.forEach(e=>{
    const [x,y]=e.split("-").map(Number);
    if(x===i)a.push(y);
    if(y===i)a.push(x);
  });
  return a;
}

function createNode(x,y){
  const i=nodes.length;
  positions[i]={x,y};
  originalPositions[i]={x,y};

  const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
  c.setAttribute("cx",x);
  c.setAttribute("cy",y);
  c.setAttribute("r",R);
  c.dataset.state="0";

  const t=document.createElementNS("http://www.w3.org/2000/svg","text");
  t.setAttribute("x",x);
  t.setAttribute("y",y);

  c.onclick=e=>{
    e.stopPropagation();

    if(!editMode){
      adjacency(i).forEach(increment);
      return;
    }

    if(addingEdge){
      if(edgeStart===null){
        edgeStart=i;
        c.setAttribute("stroke","white");
        c.setAttribute("stroke-width","3");
      } else if(edgeStart!==i){
        edges.add([Math.min(edgeStart,i),Math.max(edgeStart,i)].join("-"));
        clearEdgeSelection();
        drawEdges();
      }
      return;
    }
  };

  svg.appendChild(c);
  svg.appendChild(t);
  nodes.push(c);
  labels.push(t);
  update(i);
  drawEdges();
}

function increment(i){
  nodes[i].dataset.state=(+nodes[i].dataset.state+1)%k;
  update(i);
}

function update(i){
  const s=+nodes[i].dataset.state;
  nodes[i].setAttribute("fill",COLORS[s%COLORS.length]);
  labels[i].textContent=s;
  labels[i].style.display=displayMode==="numbers"?"block":"none";
}

/* ---------- EDGES ---------- */
function drawEdges(){
  const old=svg.querySelector("g");
  if(old) old.remove();
  const g=document.createElementNS("http://www.w3.org/2000/svg","g");

  edges.forEach(e=>{
    const [i,j]=e.split("-").map(Number);
    const p=positions[i], q=positions[j];

    if(!linear){
      const l=document.createElementNS("http://www.w3.org/2000/svg","line");
      l.setAttribute("x1",p.x);
      l.setAttribute("y1",p.y);
      l.setAttribute("x2",q.x);
      l.setAttribute("y2",q.y);
      l.setAttribute("stroke","#666");
      l.setAttribute("stroke-width","2");
      g.appendChild(l);
    } else {
      const d=Math.abs(i-j);
      const cx=SIZE/2+160+d*35;
      const cy=(p.y+q.y)/2;
      const path=document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d",`M ${p.x} ${p.y} Q ${cx} ${cy} ${q.x} ${q.y}`);
      path.setAttribute("fill","none");
      path.setAttribute("stroke","#888");
      path.setAttribute("stroke-width","2");
      g.appendChild(path);
    }
  });

  svg.prepend(g);
}

function clearEdgeSelection(){
  nodes.forEach(n=>n.removeAttribute("stroke"));
  edgeStart=null;
}

/* ---------- PRESET GRAPHS ---------- */
function buildGrid(r,c){
  reset();
  const sx=80, sy=80;
  const ox=SIZE/2-(c-1)*sx/2;
  const oy=SIZE/2-(r-1)*sy/2;

  for(let i=0;i<r;i++)
    for(let j=0;j<c;j++)
      createNode(ox+j*sx,oy+i*sy);

  const n=r*c;
  for(let i=0;i<n;i++){
    const row=Math.floor(i/c), col=i%c;
    if(row<r-1) edges.add(`${i}-${i+c}`);
    if(col<c-1) edges.add(`${i}-${i+1}`);
  }
  drawEdges();
}

function buildRing(n){
  reset();
  const cx=SIZE/2, cy=SIZE/2, rad=200;
  for(let i=0;i<n;i++){
    const a=2*Math.PI*i/n;
    createNode(cx+Math.cos(a)*rad,cy+Math.sin(a)*rad);
  }
  for(let i=0;i<n;i++)
    edges.add(`${i}-${(i+1)%n}`);
  drawEdges();
}

/* ---------- LINEARIZATION ---------- */
function animateLinearize(){
  const start=positions.map(p=>({...p}));
  const end=[];
  const x=SIZE/2, sp=SIZE/(nodes.length+1);

  if(!linear){
    for(let i=0;i<nodes.length;i++) end[i]={x,y:sp*(i+1)};
  } else {
    for(let i=0;i<nodes.length;i++) end[i]={...originalPositions[i]};
  }

  linear=!linear;
  const t0=performance.now(), dur=700;

  function step(t){
    const u=Math.min((t-t0)/dur,1);
    const s=u*u*(3-2*u);
    nodes.forEach((n,i)=>{
      const x=start[i].x+(end[i].x-start[i].x)*s;
      const y=start[i].y+(end[i].y-start[i].y)*s;
      positions[i]={x,y};
      n.setAttribute("cx",x);
      n.setAttribute("cy",y);
      labels[i].setAttribute("x",x);
      labels[i].setAttribute("y",y);
    });
    drawEdges();
    if(u<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ---------- UI ---------- */

// Global Mode toggle button
const modeBtn = document.getElementById("modeBtn");
modeBtn.onclick = () => {
  editMode = !editMode;
  modeBtn.textContent = `Mode: ${editMode ? "EDIT" : "PLAY"}`;
};

// Custom mode toggle editing button
const editToggleBtn = document.getElementById("editToggleBtn");
editToggleBtn.onclick = () => {
  editMode = !editMode;
  editToggleBtn.textContent = editMode ? "Stop Editing" : "Start Editing";
  addingNode=false;
  addingEdge=false;
  clearEdgeSelection();
};

// Custom mode Add Node / Add Edge
addNodeBtn.onclick=()=>{addingNode=true;addingEdge=false;clearEdgeSelection()};
addEdgeBtn.onclick=()=>{addingEdge=true;addingNode=false;clearEdgeSelection()};

// Shared buttons
document.getElementById("randomBtn").onclick=()=>nodes.forEach((_,i)=>{nodes[i].dataset.state=Math.floor(Math.random()*k);update(i)});
document.getElementById("displayBtn").onclick=()=>{
  displayMode=displayMode==="colors"?"numbers":"colors";
  document.getElementById("displayBtn").textContent=`Display: ${displayMode.toUpperCase()}`;
  nodes.forEach((_,i)=>update(i));
};
document.getElementById("linearBtn").onclick=animateLinearize;
document.getElementById("stateCount").onchange=e=>{
  k=Math.max(2,+e.target.value);
  nodes.forEach((n,i)=>{n.dataset.state%=k;update(i)});
};

// Graph selection
graphMode.onchange=()=>{
  graphType=graphMode.value;
  presetControls.innerHTML="";
  customControls.style.display=graphType==="custom"?"block":"none";

  addingNode=false; addingEdge=false;

  if(graphType==="grid"){
    presetControls.innerHTML=`Rows <input id="r" value="5" min="1"> Cols <input id="c" value="5" min="1">`;
    r.oninput=c.oninput=()=>buildGrid(+r.value,+c.value);
    buildGrid(5,5);
  }
  if(graphType==="ring"){
    presetControls.innerHTML=`Nodes: <input type="range" id="n" min="3" max="40" value="12"> <span id="nLabel">12</span>`;
    const nSlider=document.getElementById("n");
    const nLabel=document.getElementById("nLabel");
    nSlider.oninput=()=>{
      nLabel.textContent=nSlider.value;
      buildRing(+nSlider.value);
    };
    buildRing(12);
  }
  if(graphType==="custom"){
    reset();
  }
};

// Custom mode: click to add node
svg.onclick=e=>{
  if(graphType==="custom" && addingNode){
    const r=svg.getBoundingClientRect();
    createNode(e.clientX-r.left,e.clientY-r.top);
  }
};

// Initialize
graphMode.onchange();
</script>

</body>
</html>
