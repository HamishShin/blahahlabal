<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Custom Graph Lights Out</title>

<style>
  body {
    background: #111;
    color: white;
    font-family: sans-serif;
    text-align: center;
  }
  svg {
    background: #1a1a1a;
    border-radius: 10px;
    margin-top: 10px;
    cursor: crosshair;
  }
  circle {
    cursor: pointer;
  }
  text {
    pointer-events: none;
    font-size: 14px;
    font-weight: bold;
    fill: white;
    text-anchor: middle;
    dominant-baseline: middle;
  }
  button, input {
    margin: 5px;
  }
</style>
</head>

<body>

<h2>Custom Graph Lights Out</h2>

<button id="modeBtn">Mode: PLAY</button>
<button id="addNodeBtn">Add Node</button>
<button id="addEdgeBtn">Add Edge</button>
<button id="randomBtn">Randomize</button>
<button id="displayBtn">Display: COLORS</button>
<button id="linearBtn">Linearize</button>

<br>
States (k):
<input type="number" id="stateCount" value="2" min="2" max="8">

<svg id="svg" width="600" height="600"></svg>

<script>
const svg = document.getElementById("svg");

const SIZE = 600;
const R = 12;
const COLORS = ["#ff0000","#0000ff","#00ff00","#ffff00","#ff00ff","#00ffff","#ffffff","#ff8800"];

let nodes = [];
let labels = [];
let positions = [];
let originalPositions = [];
let edges = new Set();

let editMode = false;
let displayMode = "colors";
let k = 2;
let linear = false;

let addingNode = false;
let addingEdge = false;
let edgeStart = null;

/* ---------- CORE ---------- */

function adjacency(i) {
  const list = [i];
  edges.forEach(e => {
    const [a,b] = e.split("-").map(Number);
    if (a === i) list.push(b);
    if (b === i) list.push(a);
  });
  return list;
}

function createNode(x,y) {
  const i = nodes.length;
  positions[i] = {x,y};
  originalPositions[i] = {x,y};

  const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
  c.setAttribute("cx",x);
  c.setAttribute("cy",y);
  c.setAttribute("r",R);
  c.dataset.state = "0";

  const t = document.createElementNS("http://www.w3.org/2000/svg","text");
  t.setAttribute("x",x);
  t.setAttribute("y",y);

  c.onclick = e => {
    e.stopPropagation();

    if (addingEdge) {
      if (edgeStart === null) {
        edgeStart = i;
        c.setAttribute("stroke","white");
        c.setAttribute("stroke-width","3");
      } else if (edgeStart !== i) {
        const a = Math.min(edgeStart,i);
        const b = Math.max(edgeStart,i);
        edges.add(`${a}-${b}`);
        clearEdgeSelection();
        drawEdges();
      }
      return;
    }

    if (editMode) increment(i);
    else adjacency(i).forEach(increment);
  };

  svg.appendChild(c);
  svg.appendChild(t);
  nodes.push(c);
  labels.push(t);
  update(i);
  drawEdges();
}

function clearEdgeSelection() {
  nodes.forEach(n => n.removeAttribute("stroke"));
  edgeStart = null;
}

function increment(i) {
  nodes[i].dataset.state = (+nodes[i].dataset.state + 1) % k;
  update(i);
}

function update(i) {
  const s = +nodes[i].dataset.state;
  nodes[i].setAttribute("fill", COLORS[s % COLORS.length]);
  labels[i].textContent = s;
  labels[i].style.display = displayMode === "numbers" ? "block" : "none";
}

/* ---------- EDGES ---------- */

function drawEdges() {
  const old = svg.querySelector("g");
  if (old) old.remove();

  const g = document.createElementNS("http://www.w3.org/2000/svg","g");

  edges.forEach(e => {
    const [i,j] = e.split("-").map(Number);
    const p = positions[i];
    const q = positions[j];

    if (!linear) {
      const l = document.createElementNS("http://www.w3.org/2000/svg","line");
      l.setAttribute("x1",p.x);
      l.setAttribute("y1",p.y);
      l.setAttribute("x2",q.x);
      l.setAttribute("y2",q.y);
      l.setAttribute("stroke","#666");
      l.setAttribute("stroke-width","2");
      g.appendChild(l);
    } else {
      const d = Math.abs(i-j);
      const cx = SIZE/2 + 150 + d*40;
      const cy = (p.y + q.y)/2;

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute(
        "d",
        `M ${p.x} ${p.y} Q ${cx} ${cy} ${q.x} ${q.y}`
      );
      path.setAttribute("fill","none");
      path.setAttribute("stroke","#888");
      path.setAttribute("stroke-width","2");
      g.appendChild(path);
    }
  });

  svg.prepend(g);
}

/* ---------- LINEARIZATION ---------- */

function animateLinearize() {
  const start = positions.map(p=>({...p}));
  const end = [];
  const x = SIZE/2;
  const spacing = SIZE/(nodes.length+1);

  if (!linear) {
    for (let i=0;i<nodes.length;i++)
      end[i] = {x, y: spacing*(i+1)};
  } else {
    for (let i=0;i<nodes.length;i++)
      end[i] = {...originalPositions[i]};
  }

  linear = !linear;
  const t0 = performance.now();
  const dur = 700;

  function step(t) {
    const u = Math.min((t - t0)/dur,1);
    const s = u*u*(3-2*u);

    nodes.forEach((n,i)=>{
      const x = start[i].x + (end[i].x - start[i].x)*s;
      const y = start[i].y + (end[i].y - start[i].y)*s;
      positions[i]={x,y};
      n.setAttribute("cx",x);
      n.setAttribute("cy",y);
      labels[i].setAttribute("x",x);
      labels[i].setAttribute("y",y);
    });

    drawEdges();
    if (u<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ---------- UI ---------- */

modeBtn.onclick = () => {
  editMode = !editMode;
  modeBtn.textContent = `Mode: ${editMode?"EDIT":"PLAY"}`;
};

addNodeBtn.onclick = () => {
  addingNode = true;
  addingEdge = false;
  clearEdgeSelection();
};

addEdgeBtn.onclick = () => {
  addingEdge = true;
  addingNode = false;
  clearEdgeSelection();
};

svg.onclick = e => {
  if (addingNode) {
    const rect = svg.getBoundingClientRect();
    createNode(e.clientX-rect.left,e.clientY-rect.top);
  }
};

randomBtn.onclick = () =>
  nodes.forEach((_,i)=>{
    nodes[i].dataset.state = Math.floor(Math.random()*k);
    update(i);
  });

displayBtn.onclick = () => {
  displayMode = displayMode==="colors"?"numbers":"colors";
  displayBtn.textContent = `Display: ${displayMode.toUpperCase()}`;
  nodes.forEach((_,i)=>update(i));
};

stateCount.onchange = e => {
  k = Math.max(2,+e.target.value);
  nodes.forEach((n,i)=>{
    n.dataset.state%=k;
    update(i);
  });
};

linearBtn.onclick = animateLinearize;
</script>

</body>
</html>
